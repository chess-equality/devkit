defaults:
  # How many agents to start for reset/bootstrap when count not provided
  agents: 3
  # Primary repo name under the dev root to set up with worktrees
  repo: ouroboros-ide
  # The base branch each per-agent branch should track from origin
  base_branch: main
  # Prefix for per-agent branch names (agent1, agent2, ...)
  branch_prefix: agent
ingress:
  kind: caddy
  routes:
    - host: ouroboros.test
      service: dev-agent
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: webserver.ouroboros.test
      service: dev-agent
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
  hosts:
    - ouroboros.test
    - webserver.ouroboros.test

hooks:
  # Install Go toolchain if missing so tests can run without manual setup
  warm: |
    set -euo pipefail
    mkdir -p /workspace/.local/bin
    if command -v python3 >/dev/null 2>&1 && ! command -v python >/dev/null 2>&1; then
      ln -sf "$(command -v python3)" /workspace/.local/bin/python
    fi
    if command -v go >/dev/null 2>&1; then
      exit 0
    fi
    version="${DEVKIT_GO_VERSION:-1.22.4}"
    arch="$(uname -m)"
    case "$arch" in
      x86_64|amd64) arch=amd64 ;;
      arm64|aarch64) arch=arm64 ;;
      *)
        echo "[dev-all warm] unsupported architecture: $arch" >&2
        exit 0
        ;;
    esac
    root=/workspace/.toolchains
    dest="$root/go"
    mkdir -p "$root"
    tmpdir="$(mktemp -d)"
    tarball="go${version}.linux-${arch}.tar.gz"
    url="${DEVKIT_GO_DOWNLOAD_URL:-https://go.dev/dl/${tarball}}"
    if command -v curl >/dev/null 2>&1; then
      if ! curl -fsSL "$url" -o "$tmpdir/go.tgz"; then
        echo "[dev-all warm] failed to download Go from $url" >&2
        exit 0
      fi
    elif command -v wget >/dev/null 2>&1; then
      if ! wget -q -O "$tmpdir/go.tgz" "$url"; then
        echo "[dev-all warm] failed to download Go from $url" >&2
        exit 0
      fi
    else
      echo "[dev-all warm] curl or wget required to bootstrap Go" >&2
      exit 0
    fi
    rm -rf "$dest"
    mkdir -p "$dest"
    tar -C "$root" -xzf "$tmpdir/go.tgz"
    rm -rf "$tmpdir"
  maintain: ""

env_files:
  - ../shared/env/dev-all.env
