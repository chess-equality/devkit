defaults:
  # How many agents to start for reset/bootstrap when count not provided
  agents: 3
  # Primary repo name under the dev root to set up with worktrees
  repo: ouroboros-ide
  # The base branch each per-agent branch should track from origin
  base_branch: main
  # Prefix for per-agent branch names (agent1, agent2, ...)
  branch_prefix: agent
  # Run readiness (ssh + warm + validation) after up/restart/scale.
  auto_ready: true
  # Warm hook is required for readiness.
  require_warm: true
ingress:
  kind: caddy
  routes:
    - host: ouroboros.test
      service: dev-agent
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-1.test
      service: dev-agent@1
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-2.test
      service: dev-agent@2
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-3.test
      service: dev-agent@3
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-4.test
      service: dev-agent@4
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-5.test
      service: dev-agent@5
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-6.test
      service: dev-agent@6
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-7.test
      service: dev-agent@7
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-8.test
      service: dev-agent@8
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: webserver.ouroboros.test
      service: dev-agent
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-1.ouroboros.test
      service: dev-agent@1
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-2.ouroboros.test
      service: dev-agent@2
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-3.ouroboros.test
      service: dev-agent@3
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-4.ouroboros.test
      service: dev-agent@4
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-5.ouroboros.test
      service: dev-agent@5
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-6.ouroboros.test
      service: dev-agent@6
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-7.ouroboros.test
      service: dev-agent@7
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-8.ouroboros.test
      service: dev-agent@8
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
  hosts:
    - ouroboros.test
    - webserver.ouroboros.test
    - ouroboros-1.test
    - ouroboros-2.test
    - ouroboros-3.test
    - ouroboros-4.test
    - ouroboros-5.test
    - ouroboros-6.test
    - ouroboros-7.test
    - ouroboros-8.test
    - webserver-1.ouroboros.test
    - webserver-2.ouroboros.test
    - webserver-3.ouroboros.test
    - webserver-4.ouroboros.test
    - webserver-5.ouroboros.test
    - webserver-6.ouroboros.test
    - webserver-7.ouroboros.test
    - webserver-8.ouroboros.test

hooks:
  # Warm frontend deps and ensure playwright/typecheck tooling exists.
  warm: |
    set -euo pipefail
    if command -v npm >/dev/null 2>&1; then
      for repo in /workspaces/dev/ouroboros-ide /workspaces/dev/agent-worktrees/agent[0-9]*/ouroboros-ide; do
        if [ -f "$repo/frontend/package.json" ]; then
          npm --prefix "$repo/frontend" install --include=dev
          if [ ! -x "$repo/frontend/node_modules/.bin/tsc" ]; then
            npm --prefix "$repo/frontend" install --include=dev --no-save typescript
          fi
          if ! npm --prefix "$repo/frontend" ls @playwright/test >/dev/null 2>&1; then
            npm --prefix "$repo/frontend" install --no-save @playwright/test @vitest/browser-playwright
          fi
          npm --prefix "$repo/frontend" exec playwright install chromium
        fi
      done
    fi
    mkdir -p /workspace/.local/bin
    if command -v python3 >/dev/null 2>&1 && ! command -v python >/dev/null 2>&1; then
      ln -sf "$(command -v python3)" /workspace/.local/bin/python
    fi
  maintain: ""

env_files:
  - ../shared/env/dev-all.env
