defaults:
  # How many agents to start for reset/bootstrap when count not provided
  agents: 3
  # Primary repo name under the dev root to set up with worktrees
  repo: ouroboros-ide
  # The base branch each per-agent branch should track from origin
  base_branch: main
  # Prefix for per-agent branch names (agent1, agent2, ...)
  branch_prefix: agent
ingress:
  kind: caddy
  routes:
    - host: ouroboros.test
      service: dev-agent
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-1.test
      service: dev-agent@1
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-2.test
      service: dev-agent@2
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-3.test
      service: dev-agent@3
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-4.test
      service: dev-agent@4
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-5.test
      service: dev-agent@5
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-6.test
      service: dev-agent@6
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-7.test
      service: dev-agent@7
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-8.test
      service: dev-agent@8
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: webserver.ouroboros.test
      service: dev-agent
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-1.ouroboros.test
      service: dev-agent@1
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-2.ouroboros.test
      service: dev-agent@2
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-3.ouroboros.test
      service: dev-agent@3
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-4.ouroboros.test
      service: dev-agent@4
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-5.ouroboros.test
      service: dev-agent@5
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-6.ouroboros.test
      service: dev-agent@6
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-7.ouroboros.test
      service: dev-agent@7
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-8.ouroboros.test
      service: dev-agent@8
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
  hosts:
    - ouroboros.test
    - webserver.ouroboros.test
    - ouroboros-1.test
    - ouroboros-2.test
    - ouroboros-3.test
    - ouroboros-4.test
    - ouroboros-5.test
    - ouroboros-6.test
    - ouroboros-7.test
    - ouroboros-8.test
    - webserver-1.ouroboros.test
    - webserver-2.ouroboros.test
    - webserver-3.ouroboros.test
    - webserver-4.ouroboros.test
    - webserver-5.ouroboros.test
    - webserver-6.ouroboros.test
    - webserver-7.ouroboros.test
    - webserver-8.ouroboros.test

hooks:
  # Install Go toolchain if missing so tests can run without manual setup
  warm: |
    set -euo pipefail
    if command -v npm >/dev/null 2>&1; then
      for repo in /workspaces/dev/ouroboros-ide /workspaces/dev/agent-worktrees/agent*/ouroboros-ide; do
        if [ -f "$repo/frontend/package.json" ]; then
          npm --prefix "$repo/frontend" install
          if ! npm --prefix "$repo/frontend" ls @playwright/test >/dev/null 2>&1; then
            npm --prefix "$repo/frontend" install --no-save @playwright/test @vitest/browser-playwright
          fi
        fi
      done
    fi
    mkdir -p /workspace/.local/bin
    if command -v python3 >/dev/null 2>&1 && ! command -v python >/dev/null 2>&1; then
      ln -sf "$(command -v python3)" /workspace/.local/bin/python
    fi
    if command -v go >/dev/null 2>&1; then
      exit 0
    fi
    version="${DEVKIT_GO_VERSION:-1.22.4}"
    arch="$(uname -m)"
    case "$arch" in
      x86_64|amd64) arch=amd64 ;;
      arm64|aarch64) arch=arm64 ;;
      *)
        echo "[dev-all warm] unsupported architecture: $arch" >&2
        exit 0
        ;;
    esac
    root=/workspace/.toolchains
    dest="$root/go"
    mkdir -p "$root"
    tmpdir="$(mktemp -d)"
    tarball="go${version}.linux-${arch}.tar.gz"
    url="${DEVKIT_GO_DOWNLOAD_URL:-https://go.dev/dl/${tarball}}"
    set +e
    if command -v curl >/dev/null 2>&1; then
      curl -fsSL "$url" -o "$tmpdir/go.tgz"
      rc=$?
      if [ $rc -ne 0 ]; then
        echo "[dev-all warm] failed to download Go from $url" >&2
        exit 0
      fi
    elif command -v wget >/dev/null 2>&1; then
      wget -q -O "$tmpdir/go.tgz" "$url"
      rc=$?
      if [ $rc -ne 0 ]; then
        echo "[dev-all warm] failed to download Go from $url" >&2
        exit 0
      fi
    else
      echo "[dev-all warm] curl or wget required to bootstrap Go" >&2
      exit 0
    fi
    set -e
    rm -rf "$dest"
    mkdir -p "$dest"
    tar -C "$root" -xzf "$tmpdir/go.tgz"
    rm -rf "$tmpdir"
  maintain: ""

env_files:
  - ../shared/env/dev-all.env
