workspace: ../../ouroboros-ide
env:
  AWS_PROFILE: codex
  PATH: /workspace/.local/bin:${PATH}
hooks:
  warm: |
    set -euo pipefail
    mkdir -p /workspace/.local/bin
    if command -v python3 >/dev/null 2>&1 && ! command -v python >/dev/null 2>&1; then
      ln -sf "$(command -v python3)" /workspace/.local/bin/python
    fi
    host=$(hostname)
    base=/workspace/.devhomes
    target="${base}/${host}"
    mkdir -p "${target}/.ssh" "${target}/.cache" "${target}/.config" "${target}/.local" "${target}/.sbt"
    chmod 700 "${target}/.ssh"
    ln -sfn "${target}" /workspace/.devhome
    if [ -d /home/dev/.ivy2 ]; then ln -sfn /home/dev/.ivy2 "${target}/.ivy2"; fi
    mkdir -p "${target}/.cache"
    if [ -d /home/dev/.cache/coursier ]; then ln -sfn /home/dev/.cache/coursier "${target}/.cache/coursier"; fi
    if [ -e /home/dev/.sbt ] || [ -L /home/dev/.sbt ]; then rm -rf /home/dev/.sbt; fi
    ln -sfn "${target}/.sbt" /home/dev/.sbt
    export HOME=/workspace/.devhome
    export SBT_GLOBAL_BASE="${HOME}/.sbt"
    sbt -v update
  maintain: |
    set -euo pipefail
    mkdir -p /workspace/.local/bin
    if command -v python3 >/dev/null 2>&1 && ! command -v python >/dev/null 2>&1; then
      ln -sf "$(command -v python3)" /workspace/.local/bin/python
    fi
    host=$(hostname)
    base=/workspace/.devhomes
    target="${base}/${host}"
    mkdir -p "${target}/.ssh" "${target}/.cache" "${target}/.config" "${target}/.local" "${target}/.sbt"
    chmod 700 "${target}/.ssh"
    ln -sfn "${target}" /workspace/.devhome
    if [ -d /home/dev/.ivy2 ]; then ln -sfn /home/dev/.ivy2 "${target}/.ivy2"; fi
    mkdir -p "${target}/.cache"
    if [ -d /home/dev/.cache/coursier ]; then ln -sfn /home/dev/.cache/coursier "${target}/.cache/coursier"; fi
    if [ -e /home/dev/.sbt ] || [ -L /home/dev/.sbt ]; then rm -rf /home/dev/.sbt; fi
    ln -sfn "${target}/.sbt" /home/dev/.sbt
    export HOME=/workspace/.devhome
    export SBT_GLOBAL_BASE="${HOME}/.sbt"
    sbt compile
