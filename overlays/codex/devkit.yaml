workspace: ../../../ouroboros-ide
service: dev-agent
defaults:
  repo: ouroboros-ide
  agents: 1
  base_branch: main
  branch_prefix: agent
env:
  AWS_PROFILE: codex
  PATH: /workspace/.local/bin:${PATH}
ingress:
  kind: caddy
  routes:
    - host: ouroboros.test
      service: dev-agent
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-1.test
      service: dev-agent@1
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-2.test
      service: dev-agent@2
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-3.test
      service: dev-agent@3
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-4.test
      service: dev-agent@4
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-5.test
      service: dev-agent@5
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-6.test
      service: dev-agent@6
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-7.test
      service: dev-agent@7
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: ouroboros-8.test
      service: dev-agent@8
      port: 5173
      cert: ../../../ouroboros-ide/infra/ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/ouroboros.test-key.pem
    - host: webserver.ouroboros.test
      service: dev-agent
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-1.ouroboros.test
      service: dev-agent@1
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-2.ouroboros.test
      service: dev-agent@2
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-3.ouroboros.test
      service: dev-agent@3
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-4.ouroboros.test
      service: dev-agent@4
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-5.ouroboros.test
      service: dev-agent@5
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-6.ouroboros.test
      service: dev-agent@6
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-7.ouroboros.test
      service: dev-agent@7
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
    - host: webserver-8.ouroboros.test
      service: dev-agent@8
      port: 8080
      cert: ../../../ouroboros-ide/infra/webserver.ouroboros.test.pem
      key: ../../../ouroboros-ide/infra/webserver.ouroboros.test-key.pem
  hosts:
    - ouroboros.test
    - webserver.ouroboros.test
    - ouroboros-1.test
    - ouroboros-2.test
    - ouroboros-3.test
    - ouroboros-4.test
    - ouroboros-5.test
    - ouroboros-6.test
    - ouroboros-7.test
    - ouroboros-8.test
    - webserver-1.ouroboros.test
    - webserver-2.ouroboros.test
    - webserver-3.ouroboros.test
    - webserver-4.ouroboros.test
    - webserver-5.ouroboros.test
    - webserver-6.ouroboros.test
    - webserver-7.ouroboros.test
    - webserver-8.ouroboros.test
hooks:
  warm: |
    set -euo pipefail
    mkdir -p /workspace/.local/bin
    if command -v python3 >/dev/null 2>&1 && ! command -v python >/dev/null 2>&1; then
      ln -sf "$(command -v python3)" /workspace/.local/bin/python
    fi
    host=$(hostname)
    base=/workspace/.devhomes
    target="${base}/${host}"
    mkdir -p "${target}/.ssh" "${target}/.cache" "${target}/.config" "${target}/.local" "${target}/.sbt"
    chmod 700 "${target}/.ssh"
    ln -sfn "${target}" /workspace/.devhome
    if [ -d /home/dev/.ivy2 ]; then ln -sfn /home/dev/.ivy2 "${target}/.ivy2"; fi
    mkdir -p "${target}/.cache"
    if [ -d /home/dev/.cache/coursier ]; then ln -sfn /home/dev/.cache/coursier "${target}/.cache/coursier"; fi
    if [ -e /home/dev/.sbt ] || [ -L /home/dev/.sbt ]; then rm -rf /home/dev/.sbt; fi
    ln -sfn "${target}/.sbt" /home/dev/.sbt
    export HOME=/workspace/.devhome
    export SBT_GLOBAL_BASE="${HOME}/.sbt"
    sbt -v update
  maintain: |
    set -euo pipefail
    mkdir -p /workspace/.local/bin
    if command -v python3 >/dev/null 2>&1 && ! command -v python >/dev/null 2>&1; then
      ln -sf "$(command -v python3)" /workspace/.local/bin/python
    fi
    host=$(hostname)
    base=/workspace/.devhomes
    target="${base}/${host}"
    mkdir -p "${target}/.ssh" "${target}/.cache" "${target}/.config" "${target}/.local" "${target}/.sbt"
    chmod 700 "${target}/.ssh"
    ln -sfn "${target}" /workspace/.devhome
    if [ -d /home/dev/.ivy2 ]; then ln -sfn /home/dev/.ivy2 "${target}/.ivy2"; fi
    mkdir -p "${target}/.cache"
    if [ -d /home/dev/.cache/coursier ]; then ln -sfn /home/dev/.cache/coursier "${target}/.cache/coursier"; fi
    if [ -e /home/dev/.sbt ] || [ -L /home/dev/.sbt ]; then rm -rf /home/dev/.sbt; fi
    ln -sfn "${target}/.sbt" /home/dev/.sbt
    export HOME=/workspace/.devhome
    export SBT_GLOBAL_BASE="${HOME}/.sbt"
    sbt compile
